name: WS Deploy

on:
  push:
    branches: [ "main" ]
    paths:
      - "ws-server/**"
      - ".github/workflows/ws-deploy.yml"

jobs:
  build-push-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & Push Docker Image
        uses: docker/build-push-action@v6
        with:
          context: ./ws-server
          push: true
          tags: ghcr.io/krzysztofcal/arcadeplatform-ws:main

      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.WS_HOST }}
          username: ${{ secrets.WS_USER }}
          key: ${{ secrets.WS_SSH_KEY }}
          script: |
            set -eu
            echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u krzysztofcal --password-stdin
            cd /opt/arcade-ws
            docker compose pull
            docker compose up -d

      - name: Verify deploy health and runtime on VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.WS_HOST }}
          username: ${{ secrets.WS_USER }}
          key: ${{ secrets.WS_SSH_KEY }}
          script: |
            set -eu
            docker ps --filter name=ws --format '{{.Names}}' | grep '^ws$'
            docker inspect ws --format='{{.Config.Image}}' | grep 'ghcr.io/krzysztofcal/arcadeplatform-ws:main'
            docker logs ws --tail 20 | grep 'WS listening on'
            curl -fsS http://127.0.0.1:3000/healthz | grep '^ok$'
            docker run --rm --network host node:20-alpine sh -lc "npm i -g wscat >/dev/null 2>&1 && wscat -c wss://ws.kcswh.pl/ws -x 'ping' -w 3" | grep 'connected'
